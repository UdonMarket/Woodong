<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper  namespace="model.WooBoardImpl" >

	 
	 <!--1. 게시물 갯수 카운트 -->
	 <select id="getTotalCount" resultType="int" parameterType="model.ParameterVO">
		SELECT  count(*) FROM woo_board
	<if test="searchTxt != null and !searchTxt.equals('')">
        WHERE ${searchField} LIKE '%'||#{searchTxt}||'%' 
    </if>
	 </select> 

	 
	 <!--2. start 와 end 에 해당하는 게시물 가져오기 (페이지 처리 & 검색 처리 )  -->
	 <select id="listPage" resultType="model.WooBoardVO"  parameterType="model.ParameterVO">
	 SELECT  
	 	boardidx,
		title,
		contents,
		postdate,
		id,
		bname,
		visitcount,
		likecount,
		ltrim(to_char(price,'999,999,999')) price,
		product_state,
		chatcount,
		like_check,
		three_dimens,
		product_tag,
		woopay,
		deal_type,
		latitude,
		longitude
	 FROM 
	 	( SELECT Tb.*, rownum rNum FROM 
	 		(SELECT * FROM woo_board 
	<if test="searchTxt != null and !searchTxt.equals('')">
        WHERE ${searchField} LIKE '%'||#{searchTxt}||'%' 
    </if>
	 		order by boardidx DESC ) Tb) 
	 			WHERE rNum BETWEEN #{start} AND #{end}
	 </select> 
	 
	 <!--3. 상세보기 -->
	 <select resultType="model.WooBoardVO" id="view" parameterType="String">
	 	SELECT  
		 	boardidx,
			title,
			contents,
			postdate,
			id,
			bname,
			visitcount,
			likecount,
			ltrim(to_char(price,'999,999,999')) price,
			product_state,
			chatcount,
			like_check,
			three_dimens,
			product_tag,
			woopay,
			deal_type,
			latitude,
			longitude
	 	FROM woo_board 
	 	WHERE boardidx = #{param1} 
	 </select>
	 
	 
	  <!--3-1. 조회수 처리하기 -->
	 <update id="visitcount">
	 	UPDATE woo_board SET visitcount = visitcount+1 WHERE boardidx= #{0}
	 </update>
	 
	 <!-- 3-2. 	파일 리스트  -->
	 <select id="viewFile" parameterType="String"  resultType="model.FileVO">
	 	SELECT *
		FROM woo_file 
	 	WHERE boardidx = #{param1} 
	 	ORDER BY file_num
	 </select>
	 
	 
	<!-- 4. 글쓰기  -->	 
	  <insert id="write" parameterType="model.WooBoardVO" >
	 	INSERT INTO woo_board (
					boardidx, id, title, contents, bname,
					price, product_state, three_dimens, product_tag, woopay, 
					deal_type, latitude, longitude) 
		VALUES (
				seq_woo_board.nextval, #{id}, #{title}, #{contents}, #{bname},
				#{price}, #{product_state}, #{three_dimens}, #{product_tag}, #{woopay}, 
				#{deal_type}, #{latitude}, #{longitude})
 					
 		<selectKey  keyProperty="seq_woo_board" resultType="int" order="AFTER">
	       SELECT seq_woo_board.currval FROM dual
	    </selectKey>			
	 </insert>
	 
	 <!--4-1. 파일 업로드  -->
	 <insert id="insertFile" parameterType="map">
   	
		INSERT INTO woo_file
		(
			fileidx,
			boardidx,
			file_num,
			original_name,
			save_name,
			user_id
		)
		VALUES(
			seq_woo_file.NEXTVAL,
			#{boardidx},
			#{file_num},
			#{original_name},
			#{save_name},
			#{user_id}
		)
    </insert> 
	  
    <!--5. 수정처리하기 -->
	 <update id="update" parameterType="model.WooBoardVO">
	 	UPDATE woo_board SET 
		 	 title = #{title},
		 	 contents=#{contents},
		 	 bname=#{bname},
		 	 price=#{price},
		 	 product_state=#{product_state},
		 	 three_dimens=#{three_dimens},
		 	 product_tag=#{product_tag},
		 	 woopay=#{woopay},
		 	 deal_type=#{deal_type},
		 	 deal_location=#{deal_location}
	 	 WHERE boardidx= #{boardidx} AND id=#{id} 
	 </update>
	 
	 <!--6.  삭제하기-->
	 <delete id="delete" parameterType="model.ParameterVO" >
	 	DELETE FROM woo_board WHERE boardidx=#{boardidx} AND id=#{id}
	 </delete>
	 
	 <!-- 7. 내주변 상품 찾아오기  -->
	 <select id="searchRadius" resultType="model.WooBoardVO" parameterType="model.ParameterVO">
  		SELECT
  			boardidx,
			title,
			id,
			bname,
			ltrim(to_char(price,'999,999,999')) price,
			product_state,
			three_dimens,
			product_tag,
			latitude,
			longitude,
			trunc(to_number(DISTNACE_WGS84(#{latTxt}, #{lngTxt},latitude,longitude)),5) AS disKM,
			ROWNUM AS rNum 
		FROM woo_board
		WHERE 
				trunc(to_number(DISTNACE_WGS84(#{latTxt}, #{lngTxt},latitude,longitude)),5)<![CDATA[<=]]> 5
				AND ROWNUM BETWEEN 1 and 20
				<if test="bname!=null and !bname.equals('')">
					AND bname like #{bname}
				</if>
		ORDER BY trunc(to_number(DISTNACE_WGS84(#{latTxt}, #{lngTxt},latitude,longitude)),5) ASC
  	</select>
	 
	<select id="selectId" resultType="String">
	 	select id from woo_board where boardidx = #{0}
	 
	 </select>
	 
	 
	 <select id="selectSellingStatus" resultType="String">
	 	select deal_type from woo_board where boardidx = #{0}
	 
	 </select>
	 

	
</mapper>
